# security.mdc
## Security Baseline

**CRITICAL:** Also read `security-hardening.mdc` for detailed vulnerability patterns and fixes.

---

## Core Principle: Whitelist Over Blacklist

ALWAYS use allowlists (whitelists) instead of blocklists (blacklists).
- Blacklists can be bypassed ("you didn't say no unicycles")
- Whitelists only permit explicitly allowed operations
- This applies to: file types, operations, API endpoints, user inputs

---

### REQUIRED: Security Headers

Define security headers appropriate for hosting environment:

- **CSP (Content-Security-Policy):**
  - Report-only in development is acceptable
  - Enforced in production
  - Start restrictive, loosen only as needed
  
- **Permissions-Policy:** Deny by default, allow only what is needed
  
- **X-Frame-Options:** DENY (prevent clickjacking)
  
- **X-Content-Type-Options:** nosniff
  
- **Referrer-Policy:** strict-origin-when-cross-origin
  
- **Strict-Transport-Security:** Required for production

---

### REQUIRED: Input Validation & Sanitization

- Validate ALL untrusted inputs at the boundary
- Use schema validation (Zod recommended)
- Sanitize before storage AND before display
- Never trust client-side validation alone

**Critical Input Types:**
- File paths: Validate against directory traversal
- User-provided code/templates: NEVER execute directly
- URLs: Validate protocol and domain
- SQL/NoSQL queries: Use parameterized queries only

---

### REQUIRED: Code Execution Safety

**NEVER allow user input to reach:**
- `eval()`, `Function()`, `new Function()`
- `require()` or dynamic `import()`
- `child_process.exec()`, `execSync()`, `spawn()`
- Template engines without proper escaping
- Database query builders without parameterization

**Constructor Chain Attack Prevention:**
- Block access to `constructor` property in user contexts
- Sanitize template expressions
- Use isolated execution environments for user code

---

### REQUIRED: Authentication & Sessions

- Use secure, HTTP-only cookies for session tokens
- Enforce session timeouts appropriate to risk level
- Rotate session IDs on privilege changes
- Invalidate all sessions on password change
- Implement proper logout (server-side session destruction)

---

### REQUIRED: Authorization

- Least privilege access for all server actions
- Verify ownership/permissions on EVERY resource access
- Never rely on client-side authorization checks
- Log authorization failures for monitoring

---

### REQUIRED: Credential Management

- No client-side secrets (keys/tokens must stay server-side)
- Encrypt credentials at rest
- Use environment variables, never hardcode
- Rotate credentials on suspected compromise
- Audit credential access

---

### REQUIRED: File Upload Security

- Validate file extensions (whitelist only)
- Validate file content matches extension (magic bytes)
- Store uploads outside web root
- Generate random filenames, never use user input
- Scan for malware if accepting from untrusted sources

---

### REQUIRED: Rate Limiting

- Rate limit all public endpoints
- Rate limit authentication endpoints aggressively
- Return 429 with Retry-After header
- Log rate limit violations
- Consider progressive delays for repeated failures

---

### REQUIRED: Dependency Security

- Audit dependencies before deployment (`npm audit`)
- Pin exact versions for security-critical packages
- Review dependency updates before applying
- Monitor for CVEs in dependencies
- Use lockfiles and verify integrity

---

### REQUIRED: Network Exposure

**Never expose to public internet:**
- Database ports
- Cache/queue ports (Redis, RabbitMQ)
- Admin interfaces
- Development/debug endpoints
- Automation platforms without authentication

---

### REQUIRED: Logging & Monitoring

- Log security events (auth failures, rate limits, errors)
- Never log sensitive data (passwords, tokens, PII)
- Monitor for anomalous patterns
- Alert on critical security events
- Retain logs for incident investigation

---

### FORBIDDEN

- Disabling security features to "make it work"
- Shipping debug endpoints in production
- Verbose error messages exposing internals
- Executing user-provided code without sandboxing
- Trusting user input for file paths or code execution
- Blacklist-based security (use whitelist instead)
- Storing secrets in client-accessible code
- Default credentials in any environment
- Ignoring security warnings from linters/audits

---

### AI-Generated Code Review

AI code requires extra scrutiny at system boundaries:
- Verify input validation is present
- Check authorization on all protected routes
- Ensure no hardcoded credentials
- Validate error handling doesn't leak information
- Review data flow for sensitive information exposure

---

END OF FILE
