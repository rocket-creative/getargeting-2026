# testing-strategy.mdc
## Testing Strategy & Requirements

THIS FILE DEFINES WHAT TO TEST AND HOW.
Testing is not optional for production code.

---

## Testing Philosophy

**Test behavior, not implementation.**

Focus on:
- Does the user see the right thing?
- Does the form submit correctly?
- Does the link go to the right place?
- Does the page load without errors?

Not:
- Internal function implementation details
- Component rendering internals
- State management specifics

---

## Testing Pyramid

| Level | What | Tools | Coverage |
|-------|------|-------|----------|
| **E2E** | Critical user flows | Playwright | Key paths |
| **Integration** | Component interactions | Testing Library | Important features |
| **Unit** | Utility functions | Vitest/Jest | Business logic |

### Priority Order

1. **E2E tests for critical paths** (highest value)
2. **Integration tests for complex components**
3. **Unit tests for utility functions**

---

## What MUST Be Tested

### Critical User Flows (E2E)

Every production site needs E2E tests for:

| Flow | Test |
|------|------|
| Navigation | All nav links work, mobile menu works |
| Contact form | Form submits, validation works, success shows |
| Cross-site links | Links between sites work correctly |
| Cookie consent | Banner shows, accept/reject work, preferences save |

### Component Tests (Integration)

| Component Type | Test |
|----------------|------|
| Forms | Validation, submission, error states |
| Accordions/Tabs | Open/close, keyboard navigation |
| Modals | Open/close, focus trap, escape key |
| Navigation | Active states, mobile toggle |

### Utility Functions (Unit)

| Function Type | Test |
|---------------|------|
| Data formatting | Date formatting, phone formatting |
| Validation | Email validation, required fields |
| URL helpers | URL construction, parameter handling |
| Schema generators | JSON-LD output |

---

## What NOT to Test

- Third-party library internals
- CSS styling (use visual regression if needed)
- Static content that rarely changes
- Implementation details that could change

---

## Test File Structure

```
src/
├── components/
│   └── ContactForm/
│       ├── ContactForm.tsx
│       └── ContactForm.test.tsx    # Integration test
├── lib/
│   └── utils/
│       ├── formatPhone.ts
│       └── formatPhone.test.ts     # Unit test
└── e2e/
    ├── navigation.spec.ts          # E2E test
    ├── contact-form.spec.ts
    └── cookie-consent.spec.ts
```

---

## E2E Test Examples

### Navigation Test

```typescript
// e2e/navigation.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Navigation', () => {
  test('all main nav links work', async ({ page }) => {
    await page.goto('/')
    
    // Test each nav link
    const navLinks = [
      { text: 'About', url: '/about' },
      { text: 'Services', url: '/services' },
      { text: 'Team', url: '/team' },
      { text: 'Locations', url: '/locations' },
      { text: 'Contact', url: '/contact' },
    ]
    
    for (const link of navLinks) {
      await page.click(`nav >> text=${link.text}`)
      await expect(page).toHaveURL(new RegExp(link.url))
      await page.goto('/') // Reset
    }
  })
  
  test('mobile menu opens and closes', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 })
    await page.goto('/')
    
    // Menu should be closed
    await expect(page.locator('nav[aria-expanded="true"]')).not.toBeVisible()
    
    // Open menu
    await page.click('[aria-label="Open menu"]')
    await expect(page.locator('nav[aria-expanded="true"]')).toBeVisible()
    
    // Close menu
    await page.click('[aria-label="Close menu"]')
    await expect(page.locator('nav[aria-expanded="true"]')).not.toBeVisible()
  })
})
```

### Contact Form Test

```typescript
// e2e/contact-form.spec.ts
import { test, expect } from '@playwright/test'

test.describe('Contact Form', () => {
  test('submits successfully with valid data', async ({ page }) => {
    await page.goto('/contact')
    
    await page.fill('input[name="name"]', 'Test User')
    await page.fill('input[name="email"]', 'test@example.com')
    await page.fill('input[name="phone"]', '555-123-4567')
    await page.fill('textarea[name="message"]', 'Test message')
    
    await page.click('button[type="submit"]')
    
    await expect(page.locator('text=Thank you')).toBeVisible()
  })
  
  test('shows validation errors for empty required fields', async ({ page }) => {
    await page.goto('/contact')
    
    await page.click('button[type="submit"]')
    
    await expect(page.locator('text=Name is required')).toBeVisible()
    await expect(page.locator('text=Email is required')).toBeVisible()
  })
})
```

---

## Integration Test Examples

### Form Component Test

```typescript
// components/ContactForm/ContactForm.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { ContactForm } from './ContactForm'

describe('ContactForm', () => {
  it('validates email format', async () => {
    render(<ContactForm />)
    
    const emailInput = screen.getByLabelText(/email/i)
    fireEvent.change(emailInput, { target: { value: 'invalid-email' } })
    fireEvent.blur(emailInput)
    
    await waitFor(() => {
      expect(screen.getByText(/valid email/i)).toBeInTheDocument()
    })
  })
  
  it('disables submit button while submitting', async () => {
    render(<ContactForm />)
    
    // Fill form
    fireEvent.change(screen.getByLabelText(/name/i), { target: { value: 'Test' } })
    fireEvent.change(screen.getByLabelText(/email/i), { target: { value: 'test@test.com' } })
    
    const submitButton = screen.getByRole('button', { name: /submit/i })
    fireEvent.click(submitButton)
    
    expect(submitButton).toBeDisabled()
  })
})
```

---

## Unit Test Examples

### Utility Function Test

```typescript
// lib/utils/formatPhone.test.ts
import { formatPhone } from './formatPhone'

describe('formatPhone', () => {
  it('formats 10-digit number correctly', () => {
    expect(formatPhone('5551234567')).toBe('(555) 123-4567')
  })
  
  it('handles number with country code', () => {
    expect(formatPhone('+15551234567')).toBe('(555) 123-4567'
  })
  
  it('returns original if invalid', () => {
    expect(formatPhone('123')).toBe('123')
  })
})
```

---

## Running Tests

### Commands

```bash
# Unit and integration tests
npm test

# E2E tests
npm run test:e2e

# E2E tests with UI
npm run test:e2e:ui

# Coverage report
npm run test:coverage
```

### CI/CD Integration

Tests should run on:
- Every pull request
- Before deployment to production
- Nightly for E2E (optional)

---

## Coverage Requirements

### Minimum Coverage

| Type | Minimum |
|------|---------|
| Utility functions | 80% |
| Form components | 70% |
| Critical paths (E2E) | 100% of defined paths |

### What Counts as Covered

- Function is called during test
- Branch is executed
- Error path is tested

### What Doesn't Count

- Lines covered but not asserted
- Happy path only (need error paths too)

---

## Test Maintenance

### When to Update Tests

- When feature behavior changes
- When bug is fixed (add regression test)
- When new feature is added

### When to Delete Tests

- When feature is removed
- When test is flaky and provides no value
- When test tests implementation, not behavior

---

## Accessibility Testing

### Automated

```typescript
import { axe, toHaveNoViolations } from 'jest-axe'

expect.extend(toHaveNoViolations)

it('has no accessibility violations', async () => {
  const { container } = render(<Component />)
  const results = await axe(container)
  expect(results).toHaveNoViolations()
})
```

### Manual Checklist

- [ ] Tab through entire page
- [ ] Use screen reader on key flows
- [ ] Test with zoom at 200%
- [ ] Test with high contrast mode

---

## Visual Regression (Optional)

For design-critical pages, consider:

```typescript
// Using Playwright
test('homepage visual regression', async ({ page }) => {
  await page.goto('/')
  await expect(page).toHaveScreenshot('homepage.png')
})
```

---

## FORBIDDEN

- Skipping tests to meet deadlines
- Commenting out failing tests
- Tests that always pass (no assertions)
- Tests that depend on external services without mocking
- Flaky tests in CI (fix or remove)

---

END OF FILE
